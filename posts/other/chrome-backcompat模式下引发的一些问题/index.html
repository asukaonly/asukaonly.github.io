<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Chrome BackCompat模式下引发的一些问题 · 404 NOT FOUND
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="description" content="今天在使用vue和layer写一个页面的时候遇到一个诡异的问题，在调用layer.open()时弹出层并没有出现，但是背后的遮罩层出现了，在查看html代码后发现弹出层style的top值有问题，于是翻阅layer的代码，发现计算弹出层位置的坐标是通过调用jquery的height()函数计算当前窗口可视的高度，再减去弹出层的高度除以2得来的。
var that = this, config = that.config, layero = that.layero; var area = [layero.outerWidth(), layero.outerHeight()]; var type = typeof config.offset === &#39;object&#39;; that.offsetTop = (win.height() - area[1])/2; that.offsetLeft = (win.width() - area[0])/2; 在控制台中使用$(window).height()测试后发现结果与实际不符，猜测可能是jquery版本太低有bug或者jquery与我某个js冲突了，去翻阅jquery的代码，jquery中height()的实现代码如下：
jQuery.each({ Height: &#34;height&#34;, Width: &#34;width&#34; }, function(name, type) { jQuery.each({ padding: &#34;inner&#34; &#43; name, content: type, &#34;&#34;: &#34;outer&#34; &#43; name }, function(defaultExtra, funcName) { // margin is only for outerHeight, outerWidth jQuery.fn[funcName] = function(margin, value) { var chainable = arguments.">
<meta name="keywords" content="blog,developer,personal,">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Chrome BackCompat模式下引发的一些问题">
  <meta name="twitter:description" content="今天在使用vue和layer写一个页面的时候遇到一个诡异的问题，在调用layer.open()时弹出层并没有出现，但是背后的遮罩层出现了，在查看html代码后发现弹出层style的top值有问题，于是翻阅layer的代码，发现计算弹出层位置的坐标是通过调用jquery的height()函数计算当前窗口可视的高度，再减去弹出层的高度除以2得来的。
var that = this, config = that.config, layero = that.layero; var area = [layero.outerWidth(), layero.outerHeight()]; var type = typeof config.offset === &#39;object&#39;; that.offsetTop = (win.height() - area[1])/2; that.offsetLeft = (win.width() - area[0])/2; 在控制台中使用$(window).height()测试后发现结果与实际不符，猜测可能是jquery版本太低有bug或者jquery与我某个js冲突了，去翻阅jquery的代码，jquery中height()的实现代码如下：
jQuery.each({ Height: &#34;height&#34;, Width: &#34;width&#34; }, function(name, type) { jQuery.each({ padding: &#34;inner&#34; &#43; name, content: type, &#34;&#34;: &#34;outer&#34; &#43; name }, function(defaultExtra, funcName) { // margin is only for outerHeight, outerWidth jQuery.fn[funcName] = function(margin, value) { var chainable = arguments.">

<meta property="og:url" content="http://localhost:1313/posts/other/chrome-backcompat%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/">
  <meta property="og:site_name" content="404 NOT FOUND">
  <meta property="og:title" content="Chrome BackCompat模式下引发的一些问题">
  <meta property="og:description" content="今天在使用vue和layer写一个页面的时候遇到一个诡异的问题，在调用layer.open()时弹出层并没有出现，但是背后的遮罩层出现了，在查看html代码后发现弹出层style的top值有问题，于是翻阅layer的代码，发现计算弹出层位置的坐标是通过调用jquery的height()函数计算当前窗口可视的高度，再减去弹出层的高度除以2得来的。
var that = this, config = that.config, layero = that.layero; var area = [layero.outerWidth(), layero.outerHeight()]; var type = typeof config.offset === &#39;object&#39;; that.offsetTop = (win.height() - area[1])/2; that.offsetLeft = (win.width() - area[0])/2; 在控制台中使用$(window).height()测试后发现结果与实际不符，猜测可能是jquery版本太低有bug或者jquery与我某个js冲突了，去翻阅jquery的代码，jquery中height()的实现代码如下：
jQuery.each({ Height: &#34;height&#34;, Width: &#34;width&#34; }, function(name, type) { jQuery.each({ padding: &#34;inner&#34; &#43; name, content: type, &#34;&#34;: &#34;outer&#34; &#43; name }, function(defaultExtra, funcName) { // margin is only for outerHeight, outerWidth jQuery.fn[funcName] = function(margin, value) { var chainable = arguments.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2017-11-08T14:22:32+00:00">
    <meta property="article:modified_time" content="2017-11-08T14:22:32+00:00">
    <meta property="article:tag" content="Program">
    <meta property="article:tag" content="Frontend">




<link rel="canonical" href="http://localhost:1313/posts/other/chrome-backcompat%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">








 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      404 NOT FOUND
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/other/chrome-backcompat%E6%A8%A1%E5%BC%8F%E4%B8%8B%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98/">
              Chrome BackCompat模式下引发的一些问题
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2017-11-08T14:22:32Z">
                November 8, 2017
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              2-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="/categories/program/">Program</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/program/">Program</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/frontend/">Frontend</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>　　今天在使用vue和layer写一个页面的时候遇到一个诡异的问题，在调用layer.open()时弹出层并没有出现，但是背后的遮罩层出现了，在查看html代码后发现弹出层style的top值有问题，于是翻阅layer的代码，发现计算弹出层位置的坐标是通过调用jquery的height()函数计算当前窗口可视的高度，再减去弹出层的高度除以2得来的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">var</span> that <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">this</span>, config <span style="color:#555">=</span> that.config, layero <span style="color:#555">=</span> that.layero;
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">var</span> area <span style="color:#555">=</span> [layero.outerWidth(), layero.outerHeight()];
</span></span><span style="display:flex;"><span>  <span style="color:#069;font-weight:bold">var</span> type <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">typeof</span> config.offset <span style="color:#555">===</span> <span style="color:#c30">&#39;object&#39;</span>;
</span></span><span style="display:flex;"><span>  that.offsetTop <span style="color:#555">=</span> (win.height() <span style="color:#555">-</span> area[<span style="color:#f60">1</span>])<span style="color:#555">/</span><span style="color:#f60">2</span>;
</span></span><span style="display:flex;"><span>  that.offsetLeft <span style="color:#555">=</span> (win.width() <span style="color:#555">-</span> area[<span style="color:#f60">0</span>])<span style="color:#555">/</span><span style="color:#f60">2</span>;
</span></span></code></pre></div><p>　　在控制台中使用$(window).height()测试后发现结果与实际不符，猜测可能是jquery版本太低有bug或者jquery与我某个js冲突了，去翻阅jquery的代码，jquery中height()的实现代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span>jQuery.each({ Height<span style="color:#555">:</span> <span style="color:#c30">&#34;height&#34;</span>, Width<span style="color:#555">:</span> <span style="color:#c30">&#34;width&#34;</span> }, <span style="color:#069;font-weight:bold">function</span>(name, type) {
</span></span><span style="display:flex;"><span>  jQuery.each({ padding<span style="color:#555">:</span> <span style="color:#c30">&#34;inner&#34;</span> <span style="color:#555">+</span> name, content<span style="color:#555">:</span> type, <span style="color:#c30">&#34;&#34;</span><span style="color:#555">:</span> <span style="color:#c30">&#34;outer&#34;</span> <span style="color:#555">+</span> name }, <span style="color:#069;font-weight:bold">function</span>(defaultExtra, funcName) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// margin is only for outerHeight, outerWidth
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    jQuery.fn[funcName] <span style="color:#555">=</span> <span style="color:#069;font-weight:bold">function</span>(margin, value) {
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">var</span> chainable <span style="color:#555">=</span> arguments.length <span style="color:#555">&amp;&amp;</span> (defaultExtra <span style="color:#555">||</span> <span style="color:#069;font-weight:bold">typeof</span> margin <span style="color:#555">!==</span> <span style="color:#c30">&#34;boolean&#34;</span>),
</span></span><span style="display:flex;"><span>        extra <span style="color:#555">=</span> defaultExtra <span style="color:#555">||</span> (margin <span style="color:#555">===</span> <span style="color:#069;font-weight:bold">true</span> <span style="color:#555">||</span> value <span style="color:#555">===</span> <span style="color:#069;font-weight:bold">true</span> <span style="color:#555">?</span> <span style="color:#c30">&#34;margin&#34;</span> <span style="color:#555">:</span> <span style="color:#c30">&#34;border&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#069;font-weight:bold">return</span> access(<span style="color:#069;font-weight:bold">this</span>, <span style="color:#069;font-weight:bold">function</span>(elem, type, value) {
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">var</span> doc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">if</span> (jQuery.isWindow(elem)) {
</span></span><span style="display:flex;"><span>          <span style="color:#09f;font-style:italic">// As of 5/8/2012 this will yield incorrect results for Mobile Safari, but there
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          <span style="color:#09f;font-style:italic">// isn&#39;t a whole lot we can do. See pull request at this URL for discussion:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          <span style="color:#09f;font-style:italic">// https://github.com/jquery/jquery/pull/764
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          <span style="color:#069;font-weight:bold">return</span> elem.<span style="color:#366">document</span>.documentElement[<span style="color:#c30">&#34;client&#34;</span> <span style="color:#555">+</span> name];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#09f;font-style:italic">// Get document width or height
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>        <span style="color:#069;font-weight:bold">if</span> (elem.nodeType <span style="color:#555">===</span> <span style="color:#f60">9</span>) {
</span></span><span style="display:flex;"><span>          doc <span style="color:#555">=</span> elem.documentElement;
</span></span><span style="display:flex;"><span>          <span style="color:#09f;font-style:italic">// Either scroll[Width/Height] or offset[Width/Height] or client[Width/Height], whichever is greatest
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          <span style="color:#09f;font-style:italic">// unfortunately, this causes bug #3838 in IE6/8 only, but there is currently no good, small way to fix it.
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          <span style="color:#069;font-weight:bold">return</span> <span style="color:#366">Math</span>.max(
</span></span><span style="display:flex;"><span>            elem.body[<span style="color:#c30">&#34;scroll&#34;</span> <span style="color:#555">+</span> name], doc[<span style="color:#c30">&#34;scroll&#34;</span> <span style="color:#555">+</span> name],
</span></span><span style="display:flex;"><span>            elem.body[<span style="color:#c30">&#34;offset&#34;</span> <span style="color:#555">+</span> name], doc[<span style="color:#c30">&#34;offset&#34;</span> <span style="color:#555">+</span> name],
</span></span><span style="display:flex;"><span>            doc[<span style="color:#c30">&#34;client&#34;</span> <span style="color:#555">+</span> name]
</span></span><span style="display:flex;"><span>          );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#069;font-weight:bold">return</span> value <span style="color:#555">===</span> <span style="color:#069;font-weight:bold">undefined</span> <span style="color:#555">?</span>
</span></span><span style="display:flex;"><span>          <span style="color:#09f;font-style:italic">// Get width or height on the element, requesting but not forcing parseFloat
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          jQuery.css(elem, type, extra) <span style="color:#555">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#09f;font-style:italic">// Set width or height on the element
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>          jQuery.style(elem, type, value, extra);
</span></span><span style="display:flex;"><span>      }, type, chainable <span style="color:#555">?</span> margin <span style="color:#555">:</span> <span style="color:#069;font-weight:bold">undefined</span>, chainable, <span style="color:#069;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>　　因为layer使用的是$(window).height(),所以对应执行的是</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-JavaScript" data-lang="JavaScript"><span style="display:flex;"><span><span style="color:#069;font-weight:bold">if</span> (jQuery.isWindow(elem)) {
</span></span><span style="display:flex;"><span>    <span style="color:#09f;font-style:italic">// As of 5/8/2012 this will yield incorrect results for Mobile Safari, but there
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// isn&#39;t a whole lot we can do. See pull request at this URL for discussion:
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#09f;font-style:italic">// https://github.com/jquery/jquery/pull/764
</span></span></span><span style="display:flex;"><span><span style="color:#09f;font-style:italic"></span>    <span style="color:#069;font-weight:bold">return</span> elem.<span style="color:#366">document</span>.documentElement[<span style="color:#c30">&#34;client&#34;</span> <span style="color:#555">+</span> name];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>　　换言之，jquery直接调用了<strong>window.document.documentElement.clientHeight</strong>来获取当前窗口显示的高度。<br>
　　那么问题就变成了为什么document.documentElement.clientHeight返回的结果是个错误的值。经过查询后发现错误原因是因为我未在&lt;html&gt;标签中加入<code>!DOCTYPE</code>导致浏览器启用了怪异模式(quirks mode)。于是在html标签中加入!DOCTYPE后问题成功解决。</p>
<p>附CSSOM上关于clientHeight的处理顺序：</p>
<blockquote>
<p>The clientHeight attribute must run these steps:</p>
<ol>
<li>If the element has no associated CSS layout box or if the CSS layout box is inline, return zero.</li>
<li>If the element is the root element and the element’s node document is not in quirks mode, or if the element is the HTML body element and the element’s node document is in quirks mode, return the viewport height excluding the size of a rendered scroll bar (if any).</li>
<li>Return the height of the padding edge excluding the height of any rendered scrollbar between the padding edge and the border edge, ignoring any transforms that apply to the element and its ancestors.&quot;</li>
</ol>
<p>CSSOM View Module  <a href="https://drafts.csswg.org/cssom-view/#dom-element-clientheight"  class="external-link" target="_blank" rel="noopener">https://drafts.csswg.org/cssom-view/#dom-element-clientheight</a></p>
</blockquote>
<p>但在实际测试过程中发现：<br>
在怪异模式下，document.body.clientHeight均显示可视高度。但当可视高度大于body高度时，document.documentElement.clientHeight显示为可视高度；当可视高度小于等于body高度时，document.documentElement.clientHeight显示为body高度，原因还有待去考究。<br>
<strong>测试浏览器：Chrome 版本 61.0.3163.100（正式版本） （64 位）</strong>
<strong>测试系统：Window 10.0.15063</strong></p>
<p>总结一下:</p>
<ol>
<li>不添加DOCTYPE标识会使浏览器进入怪异模式，在怪异模式下浏览器的显示方法会与标准模式有许多的不同。怪异模式的具体差异详见——<a href="https://quirks.spec.whatwg.org/"  class="external-link" target="_blank" rel="noopener">Quirks Mode</a></li>
<li>怪异模式下，document.body.clientHeight显示为可视高度。当可视高度大于body高度时，document.documentElement.clientHeight显示为可视高度。当可视高度小于等于body高度时，，document.documentElement.clientHeight显示为body高度。</li>
</ol>

      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2024
    
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
