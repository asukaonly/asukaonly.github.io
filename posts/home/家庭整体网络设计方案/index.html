<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>家庭网络设计方案：从理想到实践的两年演进 | 404 NOT FOUND</title><meta name=keywords content="home"><meta name=description content="前言
早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023年新家入住后，我对家庭网络的改造断断续续持续了两年。到了2025年，终于是时候对这段历程做一些总结了。
这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。
房屋结构和网络需求
房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造（这也为后续网络改造埋下了一些隐患😭）。简略结构如下：

入住前暴露的主要问题有以下几点：

弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。
网口数量不足，无线AP只能放置在客厅，书房存在 WiFi死角。
预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。

我对家庭网络能力的主要需求如下：

  
      
          需求
          必要性
          备注
      
  
  
      
          全屋透明代理
          ⭐⭐⭐⭐⭐
          满足全屋代理的同时，需要过滤PT流量/大陆域名请求等
      
      
          内网2.5G速率
          ⭐⭐⭐⭐⭐
          综合考虑，部署万兆的成本过高，日常使用2.5G已够使用
      
      
          内网穿透
          ⭐⭐⭐⭐
          游戏联机/家庭相册共享需要
      
      
          支持内网私有域名
          ⭐⭐⭐⭐
          简化日常内网部署应用的使用
      
      
          网络监控/恢复能力
          ⭐⭐⭐
          提升故障问题发现率
      
      
          智能家居内网部署
          ⭐⭐
          提升响应速度并支持离线使用
      
      
          隐私设备子网隔离
          ⭐⭐
          摄像头、传感器类iot设备屏蔽公网
      
      
          容灾能力
          ⭐
          减少故障发生后的恢复时间
      
  

基于以上的需求，得到以下的初步结论

由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶）
由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过）
由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能)
由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。

2023年：从零搭建，先跑起来
物理拓扑
2023年的主题是建设，在入住后不久，我便设计了如下的网络拓扑：

可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。
我的主要网络设备如下：

软路由：零刻EQ12(n100/16G)
交换机：TP-LINK网管交换机 + 水星非网管交换机
无线ap：小米AX7000
服务器：X11SCA-F + E2144G + 64G ECC

硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑
系统架构
系统拓扑如下图所示

软路由
我在ESXi上虚拟化运行OpenWrt，主要出于以下考虑："><meta name=author content="luyanliang"><link rel=canonical href=https://asukaonly.github.io/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3ff5f570b5b16b0e23d0321c28b0e4cafb146eb07d09df5a2b24b3030b3ff3f9.css integrity="sha256-P/X1cLWxaw4j0DIcKLDkyvsUbrB9Cd9aKySzAws/8/k=" rel="preload stylesheet" as=style><link rel=icon href=https://asukaonly.github.io/avatar.png><link rel=icon type=image/png sizes=16x16 href=https://asukaonly.github.io/avatar.png><link rel=icon type=image/png sizes=32x32 href=https://asukaonly.github.io/avatar.png><link rel=apple-touch-icon href=https://asukaonly.github.io/avatar.png><link rel=mask-icon href=https://asukaonly.github.io/avatar.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://asukaonly.github.io/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://asukaonly.github.io/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/"><meta property="og:site_name" content="404 NOT FOUND"><meta property="og:title" content="家庭网络设计方案：从理想到实践的两年演进"><meta property="og:description" content="前言 早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023年新家入住后，我对家庭网络的改造断断续续持续了两年。到了2025年，终于是时候对这段历程做一些总结了。
这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。
房屋结构和网络需求 房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造（这也为后续网络改造埋下了一些隐患😭）。简略结构如下：
入住前暴露的主要问题有以下几点：
弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。 网口数量不足，无线AP只能放置在客厅，书房存在 WiFi死角。 预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。 我对家庭网络能力的主要需求如下：
需求 必要性 备注 全屋透明代理 ⭐⭐⭐⭐⭐ 满足全屋代理的同时，需要过滤PT流量/大陆域名请求等 内网2.5G速率 ⭐⭐⭐⭐⭐ 综合考虑，部署万兆的成本过高，日常使用2.5G已够使用 内网穿透 ⭐⭐⭐⭐ 游戏联机/家庭相册共享需要 支持内网私有域名 ⭐⭐⭐⭐ 简化日常内网部署应用的使用 网络监控/恢复能力 ⭐⭐⭐ 提升故障问题发现率 智能家居内网部署 ⭐⭐ 提升响应速度并支持离线使用 隐私设备子网隔离 ⭐⭐ 摄像头、传感器类iot设备屏蔽公网 容灾能力 ⭐ 减少故障发生后的恢复时间 基于以上的需求，得到以下的初步结论
由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶） 由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过） 由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能) 由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。 2023年：从零搭建，先跑起来 物理拓扑 2023年的主题是建设，在入住后不久，我便设计了如下的网络拓扑： 可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。
我的主要网络设备如下：
软路由：零刻EQ12(n100/16G) 交换机：TP-LINK网管交换机 + 水星非网管交换机 无线ap：小米AX7000 服务器：X11SCA-F + E2144G + 64G ECC 硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑
系统架构 系统拓扑如下图所示 软路由 我在ESXi上虚拟化运行OpenWrt，主要出于以下考虑："><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-09T20:09:05+00:00"><meta property="article:modified_time" content="2025-08-09T20:09:05+00:00"><meta property="article:tag" content="Home"><meta property="og:image" content="https://asukaonly.github.io/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://asukaonly.github.io/avatar.png"><meta name=twitter:title content="家庭网络设计方案：从理想到实践的两年演进"><meta name=twitter:description content="前言
早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023年新家入住后，我对家庭网络的改造断断续续持续了两年。到了2025年，终于是时候对这段历程做一些总结了。
这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。
房屋结构和网络需求
房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造（这也为后续网络改造埋下了一些隐患😭）。简略结构如下：

入住前暴露的主要问题有以下几点：

弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。
网口数量不足，无线AP只能放置在客厅，书房存在 WiFi死角。
预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。

我对家庭网络能力的主要需求如下：

  
      
          需求
          必要性
          备注
      
  
  
      
          全屋透明代理
          ⭐⭐⭐⭐⭐
          满足全屋代理的同时，需要过滤PT流量/大陆域名请求等
      
      
          内网2.5G速率
          ⭐⭐⭐⭐⭐
          综合考虑，部署万兆的成本过高，日常使用2.5G已够使用
      
      
          内网穿透
          ⭐⭐⭐⭐
          游戏联机/家庭相册共享需要
      
      
          支持内网私有域名
          ⭐⭐⭐⭐
          简化日常内网部署应用的使用
      
      
          网络监控/恢复能力
          ⭐⭐⭐
          提升故障问题发现率
      
      
          智能家居内网部署
          ⭐⭐
          提升响应速度并支持离线使用
      
      
          隐私设备子网隔离
          ⭐⭐
          摄像头、传感器类iot设备屏蔽公网
      
      
          容灾能力
          ⭐
          减少故障发生后的恢复时间
      
  

基于以上的需求，得到以下的初步结论

由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶）
由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过）
由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能)
由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。

2023年：从零搭建，先跑起来
物理拓扑
2023年的主题是建设，在入住后不久，我便设计了如下的网络拓扑：

可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。
我的主要网络设备如下：

软路由：零刻EQ12(n100/16G)
交换机：TP-LINK网管交换机 + 水星非网管交换机
无线ap：小米AX7000
服务器：X11SCA-F + E2144G + 64G ECC

硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑
系统架构
系统拓扑如下图所示

软路由
我在ESXi上虚拟化运行OpenWrt，主要出于以下考虑："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://asukaonly.github.io/posts/"},{"@type":"ListItem","position":2,"name":"家庭网络设计方案：从理想到实践的两年演进","item":"https://asukaonly.github.io/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"家庭网络设计方案：从理想到实践的两年演进","name":"家庭网络设计方案：从理想到实践的两年演进","description":"前言 早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023年新家入住后，我对家庭网络的改造断断续续持续了两年。到了2025年，终于是时候对这段历程做一些总结了。\n这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。\n房屋结构和网络需求 房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造（这也为后续网络改造埋下了一些隐患😭）。简略结构如下：\n入住前暴露的主要问题有以下几点：\n弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。 网口数量不足，无线AP只能放置在客厅，书房存在 WiFi死角。 预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。 我对家庭网络能力的主要需求如下：\n需求 必要性 备注 全屋透明代理 ⭐⭐⭐⭐⭐ 满足全屋代理的同时，需要过滤PT流量/大陆域名请求等 内网2.5G速率 ⭐⭐⭐⭐⭐ 综合考虑，部署万兆的成本过高，日常使用2.5G已够使用 内网穿透 ⭐⭐⭐⭐ 游戏联机/家庭相册共享需要 支持内网私有域名 ⭐⭐⭐⭐ 简化日常内网部署应用的使用 网络监控/恢复能力 ⭐⭐⭐ 提升故障问题发现率 智能家居内网部署 ⭐⭐ 提升响应速度并支持离线使用 隐私设备子网隔离 ⭐⭐ 摄像头、传感器类iot设备屏蔽公网 容灾能力 ⭐ 减少故障发生后的恢复时间 基于以上的需求，得到以下的初步结论\n由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶） 由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过） 由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能) 由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。 2023年：从零搭建，先跑起来 物理拓扑 2023年的主题是建设，在入住后不久，我便设计了如下的网络拓扑： 可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。\n我的主要网络设备如下：\n软路由：零刻EQ12(n100/16G) 交换机：TP-LINK网管交换机 + 水星非网管交换机 无线ap：小米AX7000 服务器：X11SCA-F + E2144G + 64G ECC 硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑\n系统架构 系统拓扑如下图所示 软路由 我在ESXi上虚拟化运行OpenWrt，主要出于以下考虑：\n","keywords":["home"],"articleBody":"前言 早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023年新家入住后，我对家庭网络的改造断断续续持续了两年。到了2025年，终于是时候对这段历程做一些总结了。\n这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。\n房屋结构和网络需求 房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造（这也为后续网络改造埋下了一些隐患😭）。简略结构如下：\n入住前暴露的主要问题有以下几点：\n弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。 网口数量不足，无线AP只能放置在客厅，书房存在 WiFi死角。 预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。 我对家庭网络能力的主要需求如下：\n需求 必要性 备注 全屋透明代理 ⭐⭐⭐⭐⭐ 满足全屋代理的同时，需要过滤PT流量/大陆域名请求等 内网2.5G速率 ⭐⭐⭐⭐⭐ 综合考虑，部署万兆的成本过高，日常使用2.5G已够使用 内网穿透 ⭐⭐⭐⭐ 游戏联机/家庭相册共享需要 支持内网私有域名 ⭐⭐⭐⭐ 简化日常内网部署应用的使用 网络监控/恢复能力 ⭐⭐⭐ 提升故障问题发现率 智能家居内网部署 ⭐⭐ 提升响应速度并支持离线使用 隐私设备子网隔离 ⭐⭐ 摄像头、传感器类iot设备屏蔽公网 容灾能力 ⭐ 减少故障发生后的恢复时间 基于以上的需求，得到以下的初步结论\n由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶） 由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过） 由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能) 由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。 2023年：从零搭建，先跑起来 物理拓扑 2023年的主题是建设，在入住后不久，我便设计了如下的网络拓扑： 可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。\n我的主要网络设备如下：\n软路由：零刻EQ12(n100/16G) 交换机：TP-LINK网管交换机 + 水星非网管交换机 无线ap：小米AX7000 服务器：X11SCA-F + E2144G + 64G ECC 硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑\n系统架构 系统拓扑如下图所示 软路由 我在ESXi上虚拟化运行OpenWrt，主要出于以下考虑：\n部署便利：套一层虚拟机便于在更改网络配置时不需要进行物理空间内的布线调整。 容灾能力：ESXi有完善的备份还原机制，通过备份可以快速恢复网络配置。 性能考虑：觉得软路由性能过剩，除了OpenWrt还可以安装其他的系统（这点后来证明并不现实）。 熟悉程度：相比PVE来说对ESXi更熟悉一些 OpenWrt使用了来自恩山的“高大全”版本，后来发现其中大部分功能并未用到，反而偶尔引发卡顿。\nHomeAssistant直接部署在软路由中，主要原因一是软路由设备先于服务器购买，出于调教智能家居设备的原因先安装在软路由内。二是HA需要安装HAOS才能安装插件（即必须是虚拟机版本，不能部署在容器内），当时认为TrueNAS的虚拟机能力并没有ESXi好，所以服务器买来后也没有进行迁移（后来发现N100性能根本无法与E-2144G相比😅）\n服务器 2023年618，我筹备组建第一台服务器，当时我对服务器的主要需求是以下几点：\n是一台偏存储的服务器，多盘位存储且支持SAS硬盘。 支持ecc内存。 带核显，支持视频硬解。 支持RAID。 可以装虚拟机/容器。 在淘了比较久的垃圾后，最终选用的配置如下：\n主板: 超微X11SCA-F CPU: Intel E-2144G 内存: 三星DDR4 2666 ECC 32G*2 硬盘: 希捷酷鹰4T*4 网卡: 迈络思MCX311A 机箱: 半人马座 电源: 海韵SGX500 这套配置里，最先选择的是机箱，因为家里没有位置放置机柜，想要多盘位又不想装较大的塔式机箱，最终入了半人马的机箱，颜值和扩展相对不错。\nCPU上，2144g的性能和能耗较为平衡，且核显有QSV能力，能加速视频编解码，主频3.6睿频4.5也能较好的应付日常的计算工作。 内存上由于心心念念一直想要搞一套ecc内存，这次选用了三星的ddr4 2666的纯ecc内存条(24年还坏了一根😭)。\n这套配置有几个小插曲，一是网卡一开始买的浪潮电口X540, 没想到居然不支持2.5G协商速率，害的我又重新买了一块。二是由于机箱比较小，虽然能装atx板，但硬盘接口的位置都被挡住了，没办法后续加装了一块SAS直通卡解决。\n在系统上，由于是偏存储的服务器，系统更偏向选择一些具备nas功能的系统，在Unraid/TrueNAS等一众nas系统及linux原生/虚拟机系统的抉择下，我最终选择了以TrueNAS作为我的服务器系统，理由主要是以下几点:\n相比Unraid等NAS系统，TrueNAS使用ZFS文件系统，有完善的数据验证、快照、恢复等机制。 相比直接部署linux系统, TrueNAS上有更易上手的RAID管理/监控等能力。 相比部署虚拟机系统，如ESXi或proxmox，由于TrueNAS scale已经支持了虚拟机和容器，我不需要再加一层套娃。 RAID方面，我的4块4T酷鹰组了RAIDZ1(类似RAID5)，实际容量在10T左右，确保在一块坏了的时候能够不丢失数据恢复。\n软件服务方面，我部署了以下的服务：\nqBittorrent：PT下载。 Homepage: 家庭服务仪表盘。 icloudpd: 同步iCloud照片 Jellyfin: 媒体服务器。 TinyMediaManager: 影视元数据刮削。 PhotoPrism: 照片管理 智能家居 作为ios用户，加上购买了AppleTv、HomePod等一些设备，智能家居生态自然选择了Apple的HomeKit。主要设备有:\n网关: Aqara M1S/HomePod 开关: Aqara D1 空调控制: 郎宁VRF 窗帘电机: Aqara 传感器: 小米人体传感器 门锁: 小米智能门锁 电视: AppleTv Aqara设备通过网关直接接入HomeKit，小米设备则通过HomeAssistant桥接接入。\n2024年: 问题浮现与系统优化 遇到的问题 2023年的架构基本稳定运行至2024上半年，期间虽然偶尔出现PT流量误走代理、OpenClash卡死等问题，但尚可接受。\n然而以上的拓扑存在一个致命的缺陷: 弱电箱中的网管交换机成为单点故障。一旦损坏，替换过程极为繁琐，需重新配置VLAN，且端口顺序必须与原配置一致。\n而就在2024年的5月某天，那台网管交换机突然宕机了，我在重新下单等了2天收到货后开始配置，才发现完全不记得之前的VLAN设置了。当时正值618之际，在每天晚上下班仅有的2个小时内，花了2天才将家庭网络恢复如初。这促使我决心进行网络改造，重点是稳定性和容灾能力\n链路可用性分析 既然要增强系统稳定性及容灾能力，那么首先需要梳理一下目前的网络链路以及相关的可用性需求。\n链路 可用性需求 达到可用时的最少设备 达到可用时的最少系统组件 国内访问（部分设备） ⭐⭐⭐⭐⭐ 路由器 无 无线连接 ⭐⭐⭐⭐ 路由器、AP 无 书房有线连接 ⭐⭐⭐⭐ 路由器、弱电箱到书房网线 无 客厅有线连接 ⭐⭐⭐⭐ 路由器、弱电箱到客厅网线 无 国际访问（部分设备） ⭐⭐⭐ 路由器 OpenClash PC网络 ⭐⭐⭐ 路由器、PC 无 服务器网络 ⭐⭐ 路由器、服务器 无 智能家居可用 ⭐⭐ 路由器、交换机、智能家居网关 HomeAssistant 全设备国内访问 ⭐⭐ 路由器、交换机、AP 无 全设备国际访问 ⭐⭐ 软路由设备、交换机、AP OpenClash 内网穿透 ⭐ 软路由设备 阿里DDNS、域名服务 其次，需要梳理一下网络中可能故障的节点以及其挂了后的影响面。对影响面的评估我分了以下几级：\n致命: 对网络可用性或完整性产生重大影响，且无法通过备用设备进行快恢。 严重: 对网络可用性或完整性产生较大影响，但可以通过备用设备或降级部分功能完成核心功能恢复。 一般: 对网络可用性或完整性产生影响，但有备用链路可以使用，或允许接受功能降级的情况。 轻微: 有轻微体验影响的情况 先列举一下物理设备可能的故障:\n故障节点 故障影响 应急措施 监测手段 书房至弱电箱网线故障 致命 书房的有线网络失效，需要额外引入书房ap连入客厅ap进行上网 无有效手段 客厅至弱电箱网线故障 致命 无线ap迁移至弱电箱内或书房，无线信号会受影响 无有效手段 软路由设备故障 严重 软路由设备临时替换为普通路由器拨号上网 通过ESXi和OpenWrt探活可知，但实际确认需要线下 弱电箱内交换机故障 严重 替换备用交换机 无有效手段(原网管交换机有后台可以探活，但非网管的一般没有) 书房交换机故障 严重 替换备用交换机 无有效手段(同上) 服务器设备故障 严重 无通用方案，根据故障情况处理 软路由内部署脚本进行探活 智能家居网关故障 严重 无应急方案 HA主动进行的设备探活 无线AP故障 严重 替换备用ap 通过无线ap的端口探活 然后是系统组件的可能的故障:\n故障节点 故障影响 应急措施 监测手段 ESXi故障 严重 若重启无法失效需要替换为普通路由器拨号上网 通过ESXi管理端口探活 OpenWrt故障 严重 exsi内通过备份快照快速恢复即可 通过OpenWrt管理端口探活 TrueNAS故障 严重 需要重装系统，管理配置通过备份恢复 软路由内部署脚本进行探活 OpenClash故障 一般 重启或降级 通过OpenClash端口探活 HomeAssistant故障 一般 exsi内通过备份快照快速恢复即可 通过HA端口探活 DDNS故障 轻微 重启/手动更新IP 无有效手段 物理拓扑的调整 根据上述的可用性优先级，我将物理拓扑图变成了这样:\n从物理拓扑上来看，改变不算特别大，仅是将路由器从书房移回了弱电箱，但从稳定性的角度考虑，这一项调整让家庭减少了2个强依赖项，一个就是网管交换机，就算挂了我也可以替换为普通交换机，甚至不用交换机直连客厅AP,也能保证局部的网络可用。另一个就是去除了弱电箱到书房的网线这个强依赖，一旦网线出问题，仅需降级书房的有线网络即可保障部分可用性。\n至于软路由的散热问题，一来在这一年的使用过程中，温度还算可控。二来我买了一个usb温控风扇贴着吹进行散热，整体评估放在弱电箱内问题不大。（是吗=。=）\n系统架构的升级 在系统拓扑方面，改造的东西就相对较多一些了，在聊改造细节之前，我们还是先来看看当下遇到的问题有哪些：\n由于OpenClash的性能问题，导致间歇性的断网。 当OpenClash的目标节点异常时没有主动感知，在连不上外网或者速度很慢时才能发现进行切换。 PT流量会经过代理服务器导致流量耗尽。 所有数据共用一个磁盘组，PT和重要数据的区分不够，有数据丢失风险，重要数据没有备份机制。 网络的整体监控能力较弱，出现问题无法溯源。 缺少各关键节点的容灾能力。 为了解决以上的问题，系统的拓扑变成了这样：\n软路由内的调整 由上图所示，软路由内最大的一个改变，就是将OpenClash从拨号的OpenWrt内剥离了出去，并将拨号用的OpenWrt更改为了自编译的精简版本，插件只包含了阿里ddns和mosdns，其中阿里ddns用于内网穿透，而mosdns用做代理分流使用。\n首先需要说明一下这样调整后的网络请求顺序，为方便说明，拨号用的OpenWrt简称为A， OpenClash所在的OpenWrt简称B：\nflowchart TD A[客户端访问域名\n默认网关为A] --\u003e B[A中的DNS服务由mosdns劫持，判断是否为国内域名] B -- 国内域名 --\u003e C[真实IP] B -- 国际域名 --\u003e D[mosdns转发请求至B\nB中的OpenClash直接返回FakeIP, 192.168.18.x] D --\u003e F[FakeIP] C --\u003e G{A根据ip网段进行路由判断} F --\u003e G G -- 目标IP为普通地址 --\u003e H[通过A WAN口请求] G -- 目标IP为FakeIP网段 --\u003e I[路由至B， 请求至OpenClash] I --\u003e J[截获FakeIP数据包\n还原为真实目标域名] J --\u003e K[请求被指向目标代理服务器] K --\u003e L[请求返回A] L --\u003e H 如图所示，在这种网络链路下，国内请求不会经过OpenClash，同时为了控制OpenClash影响的CPU和内存范围，我选择在ESXi内单独起了一个虚拟机，用ESXi进行最大CPU和内存的限制，尽可能做到在OpenClash异常时不会耗尽整个路由器资源。至于为什么要再套一层OpenWrt而不是直接部署OpenClash，那是为了后续有其他插件需要安装时也可以从主链路中剥离开。\n而在2024年，为什么我还将HomeAssistant部署在软路由内，原因是当时高估了软路由的性能，并且因为担心服务器挂了可能会影响智能家居设备=.=\n服务器的调整 首先提一下硬件上的调整(上图中没展示出来)，由于需要按资料重要性进行资源隔离，我新增了2块二手12T的氦气盘组了RAID 1阵列，高频读写的PT、影音等数据存在这个阵列内，原先的阵列用来存放家庭照片、数据备份、文档备份等。\n然后是服务器内部署的一些应用进行了调整:\n移除Jellyfin：由于我没有在外看视频的需求，在家的话不需要在服务器上进行解码，直接传流手机解码即可，最终方案是在手机和电视上安装了infuse作为媒体观看软件。 PhotoPrism替换为MTPhotos: PhotoPrism属实难用。 新增 Alist（网盘管理）、Calibre（电子书管理）。 部署Ubuntu虚拟机: 用来部署相关的监控脚本。 计划上会添加上prometheus+grafana作为监控套件，但实际2024年并未添加 在增强稳定性方面，服务器上的脚本担任了绝大多数的任务需求，整个监控体系如下图所示: 其中的脚本都是非常简单的shell脚本，通过http请求对应服务的管理接口，有数据就当有心跳。这里可以看出当时的一个观点：只要不挂都不是大问题（笑）。但这套体系还是有不少的监控盲区和问题，最显而易见的，就是当OpenWrt或者ESXi挂了的时候，push消息根本发不出来（这个问题居然一直到了25年才被反应过来）\n2025年: 体系化与稳定性建设 发现问题 上述调整后的架构完美运行了很长时间，期间没有发生任何大问题，偶尔的clash异常也能在重启后恢复。但没出大问题也就意味着上述的降级容灾措施并没有被实际验证过。\n时间来到2025年的夏天，某个周末开始网络会时不时出现卡顿，一开始还以为是PT下载的缘故，由于持续时间不长就没太关注。但慢慢的卡顿频率越来越多，有时候OpenWrt的CPU占用会飙升到100%，排查发现OpenWrt内CPU占用最高的线程是ksoftirqd，ksoftirqd是一个处理软中断的线程，它占CPU高往往是结果而不是原因。深入排查发现在弱电箱内的软路由在正常情况下就烫的厉害，那会不会是因为软路由散热不好导致CPU降频或网卡异常进而触发了软中断爆炸呢，在换了一个更大的散热风扇后，这个情况再没有发生。\n这个事件让我看到了2个问题：\n现有监控无法捕捉瞬时异常，缺乏历史数据追踪。 软路由的负载过高，需进一步划清设备职责。 这样下来，2025年的改造目标，重点就是：\n建设体系化监控+设备能力单一化\n监控体系升级 其实在2024年的规划中，就已经画出了grafana+prometheus的套件组合，但由于prometheus过于原始的配置方式，加上当时认为脚本探活就可以完成家庭网络的监控工作，这2者并没有被使用起来。\n回到现在，监控体系还是选择使用grafana+prometheus的组合，毕竟开源解决方案很多。安装后的效果如下。\n关于prometheus exporter的选择，目前是这样的:\n监控节点 拉取速度 核心关注指标 exporter来源 OpenWrt 5s CPU使用率、内存使用率、load、网络io、活跃连接数 OpenWrt软件包内自带 HomeAssistant 30s 设备电池电量、空调使用时间 HA插件 TrueNAS 5s CPU使用率、内存使用率、load、磁盘io、网络io https://github.com/Supporterino/TrueNAS-graphite-to-prometheus qBittorrent 60s 下载/上传速度、做种数 自建 OpenClash 20s 下载/上传速度、流量使用量、活跃连接数、国内/国际ping延时 自建 需要提的是为什么没有ESXi的exporter，原因是不想为了监控再装一个vCenter了=。=\n日志 日志及下述单一化的部分在这篇文章写作之时并没有完全调整完成，这里主要说一下我的方案。\n既然监控使用了grafana，日志当然使用promtail+loki的配套搭配，但看了文档发现promtail目前已经被弃用了，替代者是alloy，所以整个的日志方案就变成了alloy(日志采集)+loki(日志存储)+grafana(日志看板)的组合拳。\nTrueNAS内的日志采集直接部署alloy应用即可，日志基本集中在/var/log目录下，我目前是采集了/var/log/containers/*和/var/log/syslog.log用以监控应用和系统的关键日志。\nOpenWrt的日志采集，我决定参考 github 的方案在OpenWrt内直接部署日志上报的功能。\nESXi和HomeAssistant暂不接入。\n设备职责单一化 在软件工程里，KISS原则是一个非常重要的工程实践方法。回看前两年迭代的结构演进，有哪些地方违法了KISS原则呢？\n为了减少OpenClash对系统的影响，引入了mosdns进入主链路。 软路由内部署了HomeAssistant。 存储服务器承担了越来越多的计算工作。 要如何解决这3个问题呢，我目前的方案如下：\n关于问题1, 当我在2025年再次审视clash的配置时，发现其实clash本身就支持dns分流及按配置绕过内核，引入mosdns似乎并不需要，于是我将2个OpenWrt再次删减为一个，仅使用OpenClash的规则配置进行流量分流，这个方案带来的唯一问题可能CPU会被clash吃满，但这通过监控也可以完成clash自动启停。关于clash的配置，github上的这个仓库有非常详尽的教学，可以参考。\n关于问题2, 很好解决，我将HomeAssistant从软路由迁移至服务器。\n关于问题3，这实际是个成本问题（哈哈）。随着监控和日志系统的完善，我计划观察一段时间服务器使用，如果确实日常计算量很高，可能会考虑增加一台专用计算的设备保障存储设备的稳定性。（比如mac mini）\n最后 家庭网络的建设是一个持续迭代的过程，从最初的“能用到”到“稳定用”，再到“高效与可观测”，每一个阶段都伴随着新的挑战与解决方案。本文重点分享了设计思路与架构演进，具体技术细节将在后续文章展开。如果你也正在构建家庭网络，希望本文能为你提供一些参考。\n","wordCount":"421","inLanguage":"en","image":"https://asukaonly.github.io/avatar.png","datePublished":"2025-08-09T20:09:05Z","dateModified":"2025-08-09T20:09:05Z","author":{"@type":"Person","name":"luyanliang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://asukaonly.github.io/posts/home/%E5%AE%B6%E5%BA%AD%E6%95%B4%E4%BD%93%E7%BD%91%E7%BB%9C%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/"},"publisher":{"@type":"Organization","name":"404 NOT FOUND","logo":{"@type":"ImageObject","url":"https://asukaonly.github.io/avatar.png"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://asukaonly.github.io/ accesskey=h title="404 NOT FOUND (Alt + H)">404 NOT FOUND</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://asukaonly.github.io/posts/ title=Blog><span>Blog</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://asukaonly.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://asukaonly.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">家庭网络设计方案：从理想到实践的两年演进</h1><div class=post-meta><span title='2025-08-09 20:09:05 +0000 UTC'>August 9, 2025</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;421 words&nbsp;·&nbsp;luyanliang</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e6%88%bf%e5%b1%8b%e7%bb%93%e6%9e%84%e5%92%8c%e7%bd%91%e7%bb%9c%e9%9c%80%e6%b1%82 aria-label=房屋结构和网络需求>房屋结构和网络需求</a></li><li><a href=#2023%e5%b9%b4%e4%bb%8e%e9%9b%b6%e6%90%ad%e5%bb%ba%e5%85%88%e8%b7%91%e8%b5%b7%e6%9d%a5 aria-label=2023年：从零搭建，先跑起来>2023年：从零搭建，先跑起来</a><ul><li><a href=#%e7%89%a9%e7%90%86%e6%8b%93%e6%89%91 aria-label=物理拓扑>物理拓扑</a></li><li><a href=#%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84 aria-label=系统架构>系统架构</a><ul><li><a href=#%e8%bd%af%e8%b7%af%e7%94%b1 aria-label=软路由>软路由</a></li><li><a href=#%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=服务器>服务器</a></li><li><a href=#%e6%99%ba%e8%83%bd%e5%ae%b6%e5%b1%85 aria-label=智能家居>智能家居</a></li></ul></li></ul></li><li><a href=#2024%e5%b9%b4-%e9%97%ae%e9%a2%98%e6%b5%ae%e7%8e%b0%e4%b8%8e%e7%b3%bb%e7%bb%9f%e4%bc%98%e5%8c%96 aria-label="2024年: 问题浮现与系统优化">2024年: 问题浮现与系统优化</a><ul><li><a href=#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=遇到的问题>遇到的问题</a></li><li><a href=#%e9%93%be%e8%b7%af%e5%8f%af%e7%94%a8%e6%80%a7%e5%88%86%e6%9e%90 aria-label=链路可用性分析>链路可用性分析</a></li><li><a href=#%e7%89%a9%e7%90%86%e6%8b%93%e6%89%91%e7%9a%84%e8%b0%83%e6%95%b4 aria-label=物理拓扑的调整>物理拓扑的调整</a></li><li><a href=#%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84%e7%9a%84%e5%8d%87%e7%ba%a7 aria-label=系统架构的升级>系统架构的升级</a></li><li><a href=#%e8%bd%af%e8%b7%af%e7%94%b1%e5%86%85%e7%9a%84%e8%b0%83%e6%95%b4 aria-label=软路由内的调整>软路由内的调整</a></li><li><a href=#%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e8%b0%83%e6%95%b4 aria-label=服务器的调整>服务器的调整</a></li></ul></li><li><a href=#2025%e5%b9%b4-%e4%bd%93%e7%b3%bb%e5%8c%96%e4%b8%8e%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%bb%ba%e8%ae%be aria-label="2025年: 体系化与稳定性建设">2025年: 体系化与稳定性建设</a><ul><li><a href=#%e5%8f%91%e7%8e%b0%e9%97%ae%e9%a2%98 aria-label=发现问题>发现问题</a></li><li><a href=#%e7%9b%91%e6%8e%a7%e4%bd%93%e7%b3%bb%e5%8d%87%e7%ba%a7 aria-label=监控体系升级>监控体系升级</a></li><li><a href=#%e6%97%a5%e5%bf%97 aria-label=日志>日志</a></li><li><a href=#%e8%ae%be%e5%a4%87%e8%81%8c%e8%b4%a3%e5%8d%95%e4%b8%80%e5%8c%96 aria-label=设备职责单一化>设备职责单一化</a></li></ul></li><li><a href=#%e6%9c%80%e5%90%8e aria-label=最后>最后</a></li></ul></div></details></div></aside><script>let activeElement,elements;document.addEventListener("DOMContentLoaded",function(){if(checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),elements.length>0){activeElement=elements[0];const e=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${e}"]`).classList.add("active")}const t=document.getElementById("top-link");t&&t.addEventListener("click",e=>{e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})})},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{const e=window.pageYOffset||document.documentElement.scrollTop;if(e===0)return;elements&&elements.length>0&&(activeElement=Array.from(elements).find(t=>{if(getOffsetTop(t)-e>0&&getOffsetTop(t)-e<window.innerHeight/2)return t})||activeElement,elements.forEach(e=>{const n=encodeURI(e.getAttribute("id")).toLowerCase(),t=document.querySelector(`.inner ul li a[href="#${n}"]`);if(e===activeElement){t.classList.add("active");const e=document.querySelector(".toc .inner"),n=t.offsetTop,s=e.clientHeight,o=t.clientHeight,i=n-s/2+o/2;e.scrollTo({top:i,behavior:"smooth"})}else t.classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h1><p>早在毕业后的租房时期，我就时常期待拥有自己的家后要如何改造家庭网络。每次看到网上博主分享内网万兆传输、服务器机柜、NAS 阵列等内容，都不禁心生羡慕。2023年新家入住后，我对家庭网络的改造断断续续持续了两年。到了2025年，终于是时候对这段历程做一些总结了。</p><p>这篇文章将重点回顾这两年来家庭网络结构的演进过程及背后的思考。</p><h1 id=房屋结构和网络需求>房屋结构和网络需求<a hidden class=anchor aria-hidden=true href=#房屋结构和网络需求>#</a></h1><p>房屋为精装交付，出于成本考虑，入住时未对结构进行大幅改造（这也为后续网络改造埋下了一些隐患😭）。简略结构如下：</p><p><img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/%E6%88%BF%E5%B1%8B%E7%BB%93%E6%9E%84.png></p><p>入住前暴露的主要问题有以下几点：</p><ol><li>弱电箱嵌入在进门鞋柜内，空间非常有限，难以容纳较多设备，散热也较差。</li><li>网口数量不足，无线AP只能放置在客厅，书房存在 WiFi死角。</li><li>预埋网线为超五类，虽然短距离可支持万兆，但稳定性不佳。</li></ol><p>我对家庭网络能力的主要需求如下：</p><table><thead><tr><th>需求</th><th>必要性</th><th>备注</th></tr></thead><tbody><tr><td>全屋透明代理</td><td>⭐⭐⭐⭐⭐</td><td>满足全屋代理的同时，需要过滤PT流量/大陆域名请求等</td></tr><tr><td>内网2.5G速率</td><td>⭐⭐⭐⭐⭐</td><td>综合考虑，部署万兆的成本过高，日常使用2.5G已够使用</td></tr><tr><td>内网穿透</td><td>⭐⭐⭐⭐</td><td>游戏联机/家庭相册共享需要</td></tr><tr><td>支持内网私有域名</td><td>⭐⭐⭐⭐</td><td>简化日常内网部署应用的使用</td></tr><tr><td>网络监控/恢复能力</td><td>⭐⭐⭐</td><td>提升故障问题发现率</td></tr><tr><td>智能家居内网部署</td><td>⭐⭐</td><td>提升响应速度并支持离线使用</td></tr><tr><td>隐私设备子网隔离</td><td>⭐⭐</td><td>摄像头、传感器类iot设备屏蔽公网</td></tr><tr><td>容灾能力</td><td>⭐</td><td>减少故障发生后的恢复时间</td></tr></tbody></table><p>基于以上的需求，得到以下的初步结论</p><ol><li>由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶）</li><li>由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过）</li><li>由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能)</li><li>由于需要智能家居内网部署，购买设备时需要关注是否支持 Zigbee / Matter 等协议。</li></ol><h1 id=2023年从零搭建先跑起来>2023年：从零搭建，先跑起来<a hidden class=anchor aria-hidden=true href=#2023年从零搭建先跑起来>#</a></h1><h2 id=物理拓扑>物理拓扑<a hidden class=anchor aria-hidden=true href=#物理拓扑>#</a></h2><p>2023年的主题是建设，在入住后不久，我便设计了如下的网络拓扑：
<img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/2023-%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.png></p><p>可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。</p><p>我的主要网络设备如下：</p><ul><li>软路由：零刻EQ12(n100/16G)</li><li>交换机：TP-LINK网管交换机 + 水星非网管交换机</li><li>无线ap：小米AX7000</li><li>服务器：X11SCA-F + E2144G + 64G ECC</li></ul><p>硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑</p><h2 id=系统架构>系统架构<a hidden class=anchor aria-hidden=true href=#系统架构>#</a></h2><p>系统拓扑如下图所示
<img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/2023-%E7%B3%BB%E7%BB%9F%E6%8B%93%E6%89%91.jpg></p><h3 id=软路由>软路由<a hidden class=anchor aria-hidden=true href=#软路由>#</a></h3><p>我在ESXi上虚拟化运行OpenWrt，主要出于以下考虑：</p><ol><li>部署便利：套一层虚拟机便于在更改网络配置时不需要进行物理空间内的布线调整。</li><li>容灾能力：ESXi有完善的备份还原机制，通过备份可以快速恢复网络配置。</li><li>性能考虑：觉得软路由性能过剩，除了OpenWrt还可以安装其他的系统（这点后来证明并不现实）。</li><li>熟悉程度：相比PVE来说对ESXi更熟悉一些</li></ol><p>OpenWrt使用了来自恩山的“高大全”版本，后来发现其中大部分功能并未用到，反而偶尔引发卡顿。</p><p>HomeAssistant直接部署在软路由中，主要原因一是软路由设备先于服务器购买，出于调教智能家居设备的原因先安装在软路由内。二是HA需要安装HAOS才能安装插件（即必须是虚拟机版本，不能部署在容器内），当时认为TrueNAS的虚拟机能力并没有ESXi好，所以服务器买来后也没有进行迁移（后来发现N100性能根本无法与E-2144G相比😅）</p><h3 id=服务器>服务器<a hidden class=anchor aria-hidden=true href=#服务器>#</a></h3><p>2023年618，我筹备组建第一台服务器，当时我对服务器的主要需求是以下几点：</p><ol><li>是一台偏存储的服务器，多盘位存储且支持SAS硬盘。</li><li>支持ecc内存。</li><li>带核显，支持视频硬解。</li><li>支持RAID。</li><li>可以装虚拟机/容器。</li></ol><p>在淘了比较久的垃圾后，最终选用的配置如下：</p><ul><li>主板: 超微X11SCA-F</li><li>CPU: Intel E-2144G</li><li>内存: 三星DDR4 2666 ECC 32G*2</li><li>硬盘: 希捷酷鹰4T*4</li><li>网卡: 迈络思MCX311A</li><li>机箱: 半人马座</li><li>电源: 海韵SGX500</li></ul><p><img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/%E5%8D%8A%E4%BA%BA%E9%A9%AC.jpeg></p><p>这套配置里，最先选择的是机箱，因为家里没有位置放置机柜，想要多盘位又不想装较大的塔式机箱，最终入了半人马的机箱，颜值和扩展相对不错。</p><p>CPU上，2144g的性能和能耗较为平衡，且核显有QSV能力，能加速视频编解码，主频3.6睿频4.5也能较好的应付日常的计算工作。
<img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/E2144g.png></p><p>内存上由于心心念念一直想要搞一套ecc内存，这次选用了三星的ddr4 2666的纯ecc内存条(24年还坏了一根😭)。</p><p>这套配置有几个小插曲，一是网卡一开始买的浪潮电口X540, 没想到居然不支持2.5G协商速率，害的我又重新买了一块。二是由于机箱比较小，虽然能装atx板，但硬盘接口的位置都被挡住了，没办法后续加装了一块SAS直通卡解决。</p><p>在系统上，由于是偏存储的服务器，系统更偏向选择一些具备nas功能的系统，在Unraid/TrueNAS等一众nas系统及linux原生/虚拟机系统的抉择下，我最终选择了以TrueNAS作为我的服务器系统，理由主要是以下几点:</p><ol><li>相比Unraid等NAS系统，TrueNAS使用ZFS文件系统，有完善的数据验证、快照、恢复等机制。</li><li>相比直接部署linux系统, TrueNAS上有更易上手的RAID管理/监控等能力。</li><li>相比部署虚拟机系统，如ESXi或proxmox，由于TrueNAS scale已经支持了虚拟机和容器，我不需要再加一层套娃。</li></ol><p>RAID方面，我的4块4T酷鹰组了RAIDZ1(类似RAID5)，实际容量在10T左右，确保在一块坏了的时候能够不丢失数据恢复。</p><p>软件服务方面，我部署了以下的服务：</p><ul><li>qBittorrent：PT下载。</li><li>Homepage: 家庭服务仪表盘。</li><li>icloudpd: 同步iCloud照片</li><li>Jellyfin: 媒体服务器。</li><li>TinyMediaManager: 影视元数据刮削。</li><li>PhotoPrism: 照片管理</li></ul><h3 id=智能家居>智能家居<a hidden class=anchor aria-hidden=true href=#智能家居>#</a></h3><p>作为ios用户，加上购买了AppleTv、HomePod等一些设备，智能家居生态自然选择了Apple的HomeKit。主要设备有:</p><ul><li>网关: Aqara M1S/HomePod</li><li>开关: Aqara D1</li><li>空调控制: 郎宁VRF</li><li>窗帘电机: Aqara</li><li>传感器: 小米人体传感器</li><li>门锁: 小米智能门锁</li><li>电视: AppleTv</li></ul><p>Aqara设备通过网关直接接入HomeKit，小米设备则通过HomeAssistant桥接接入。</p><h1 id=2024年-问题浮现与系统优化>2024年: 问题浮现与系统优化<a hidden class=anchor aria-hidden=true href=#2024年-问题浮现与系统优化>#</a></h1><h2 id=遇到的问题>遇到的问题<a hidden class=anchor aria-hidden=true href=#遇到的问题>#</a></h2><p>2023年的架构基本稳定运行至2024上半年，期间虽然偶尔出现PT流量误走代理、OpenClash卡死等问题，但尚可接受。</p><p>然而以上的拓扑存在一个致命的缺陷: <strong>弱电箱中的网管交换机成为单点故障</strong>。一旦损坏，替换过程极为繁琐，需重新配置VLAN，且端口顺序必须与原配置一致。</p><p>而就在2024年的5月某天，那台网管交换机突然宕机了，我在重新下单等了2天收到货后开始配置，才发现完全不记得之前的VLAN设置了。当时正值618之际，在每天晚上下班仅有的2个小时内，花了2天才将家庭网络恢复如初。这促使我决心进行网络改造，重点是<strong>稳定性和容灾能力</strong></p><h2 id=链路可用性分析>链路可用性分析<a hidden class=anchor aria-hidden=true href=#链路可用性分析>#</a></h2><p>既然要增强系统稳定性及容灾能力，那么首先需要梳理一下目前的网络链路以及相关的可用性需求。</p><table><thead><tr><th>链路</th><th>可用性需求</th><th>达到可用时的最少设备</th><th>达到可用时的最少系统组件</th></tr></thead><tbody><tr><td>国内访问（部分设备）</td><td>⭐⭐⭐⭐⭐</td><td>路由器</td><td>无</td></tr><tr><td>无线连接</td><td>⭐⭐⭐⭐</td><td>路由器、AP</td><td>无</td></tr><tr><td>书房有线连接</td><td>⭐⭐⭐⭐</td><td>路由器、弱电箱到书房网线</td><td>无</td></tr><tr><td>客厅有线连接</td><td>⭐⭐⭐⭐</td><td>路由器、弱电箱到客厅网线</td><td>无</td></tr><tr><td>国际访问（部分设备）</td><td>⭐⭐⭐</td><td>路由器</td><td>OpenClash</td></tr><tr><td>PC网络</td><td>⭐⭐⭐</td><td>路由器、PC</td><td>无</td></tr><tr><td>服务器网络</td><td>⭐⭐</td><td>路由器、服务器</td><td>无</td></tr><tr><td>智能家居可用</td><td>⭐⭐</td><td>路由器、交换机、智能家居网关</td><td>HomeAssistant</td></tr><tr><td>全设备国内访问</td><td>⭐⭐</td><td>路由器、交换机、AP</td><td>无</td></tr><tr><td>全设备国际访问</td><td>⭐⭐</td><td>软路由设备、交换机、AP</td><td>OpenClash</td></tr><tr><td>内网穿透</td><td>⭐</td><td>软路由设备</td><td>阿里DDNS、域名服务</td></tr></tbody></table><p>其次，需要梳理一下网络中可能故障的节点以及其挂了后的影响面。对影响面的评估我分了以下几级：</p><ul><li>致命: 对网络可用性或完整性产生重大影响，且无法通过备用设备进行快恢。</li><li>严重: 对网络可用性或完整性产生较大影响，但可以通过备用设备或降级部分功能完成核心功能恢复。</li><li>一般: 对网络可用性或完整性产生影响，但有备用链路可以使用，或允许接受功能降级的情况。</li><li>轻微: 有轻微体验影响的情况</li></ul><p>先列举一下物理设备可能的故障:</p><table><thead><tr><th>故障节点</th><th>故障影响</th><th>应急措施</th><th>监测手段</th></tr></thead><tbody><tr><td>书房至弱电箱网线故障</td><td>致命</td><td>书房的有线网络失效，需要额外引入书房ap连入客厅ap进行上网</td><td>无有效手段</td></tr><tr><td>客厅至弱电箱网线故障</td><td>致命</td><td>无线ap迁移至弱电箱内或书房，无线信号会受影响</td><td>无有效手段</td></tr><tr><td>软路由设备故障</td><td>严重</td><td>软路由设备临时替换为普通路由器拨号上网</td><td>通过ESXi和OpenWrt探活可知，但实际确认需要线下</td></tr><tr><td>弱电箱内交换机故障</td><td>严重</td><td>替换备用交换机</td><td>无有效手段(原网管交换机有后台可以探活，但非网管的一般没有)</td></tr><tr><td>书房交换机故障</td><td>严重</td><td>替换备用交换机</td><td>无有效手段(同上)</td></tr><tr><td>服务器设备故障</td><td>严重</td><td>无通用方案，根据故障情况处理</td><td>软路由内部署脚本进行探活</td></tr><tr><td>智能家居网关故障</td><td>严重</td><td>无应急方案</td><td>HA主动进行的设备探活</td></tr><tr><td>无线AP故障</td><td>严重</td><td>替换备用ap</td><td>通过无线ap的端口探活</td></tr></tbody></table><p>然后是系统组件的可能的故障:</p><table><thead><tr><th>故障节点</th><th>故障影响</th><th>应急措施</th><th>监测手段</th></tr></thead><tbody><tr><td>ESXi故障</td><td>严重</td><td>若重启无法失效需要替换为普通路由器拨号上网</td><td>通过ESXi管理端口探活</td></tr><tr><td>OpenWrt故障</td><td>严重</td><td>exsi内通过备份快照快速恢复即可</td><td>通过OpenWrt管理端口探活</td></tr><tr><td>TrueNAS故障</td><td>严重</td><td>需要重装系统，管理配置通过备份恢复</td><td>软路由内部署脚本进行探活</td></tr><tr><td>OpenClash故障</td><td>一般</td><td>重启或降级</td><td>通过OpenClash端口探活</td></tr><tr><td>HomeAssistant故障</td><td>一般</td><td>exsi内通过备份快照快速恢复即可</td><td>通过HA端口探活</td></tr><tr><td>DDNS故障</td><td>轻微</td><td>重启/手动更新IP</td><td>无有效手段</td></tr></tbody></table><h2 id=物理拓扑的调整>物理拓扑的调整<a hidden class=anchor aria-hidden=true href=#物理拓扑的调整>#</a></h2><p>根据上述的可用性优先级，我将物理拓扑图变成了这样:</p><p><img alt=2024-网络拓扑 loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/2024-%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91.png></p><p>从物理拓扑上来看，改变不算特别大，仅是将路由器从书房移回了弱电箱，但从稳定性的角度考虑，这一项调整让家庭减少了2个强依赖项，一个就是网管交换机，就算挂了我也可以替换为普通交换机，甚至不用交换机直连客厅AP,也能保证局部的网络可用。另一个就是去除了弱电箱到书房的网线这个强依赖，一旦网线出问题，仅需降级书房的有线网络即可保障部分可用性。</p><p>至于软路由的散热问题，一来在这一年的使用过程中，温度还算可控。二来我买了一个usb温控风扇贴着吹进行散热，整体评估放在弱电箱内问题不大。（是吗=。=）</p><h2 id=系统架构的升级>系统架构的升级<a hidden class=anchor aria-hidden=true href=#系统架构的升级>#</a></h2><p>在系统拓扑方面，改造的东西就相对较多一些了，在聊改造细节之前，我们还是先来看看当下遇到的问题有哪些：</p><ol><li>由于OpenClash的性能问题，导致间歇性的断网。</li><li>当OpenClash的目标节点异常时没有主动感知，在连不上外网或者速度很慢时才能发现进行切换。</li><li>PT流量会经过代理服务器导致流量耗尽。</li><li>所有数据共用一个磁盘组，PT和重要数据的区分不够，有数据丢失风险，重要数据没有备份机制。</li><li>网络的整体监控能力较弱，出现问题无法溯源。</li><li>缺少各关键节点的容灾能力。</li></ol><p>为了解决以上的问题，系统的拓扑变成了这样：</p><p><img alt=2024-网络拓扑 loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/2024-%E7%B3%BB%E7%BB%9F%E6%8B%93%E6%89%91.jpg></p><h2 id=软路由内的调整>软路由内的调整<a hidden class=anchor aria-hidden=true href=#软路由内的调整>#</a></h2><p>由上图所示，软路由内最大的一个改变，就是将OpenClash从拨号的OpenWrt内剥离了出去，并将拨号用的OpenWrt更改为了自编译的精简版本，插件只包含了阿里ddns和mosdns，其中阿里ddns用于内网穿透，而mosdns用做代理分流使用。</p><p>首先需要说明一下这样调整后的网络请求顺序，为方便说明，拨号用的OpenWrt简称为A， OpenClash所在的OpenWrt简称B：</p><pre class=mermaid>flowchart TD
A[客户端访问域名&lt;br&gt;默认网关为A] --&gt; B[A中的DNS服务由mosdns劫持，判断是否为国内域名]
B -- 国内域名 --&gt; C[真实IP]
B -- 国际域名 --&gt; D[mosdns转发请求至B&lt;br&gt;B中的OpenClash直接返回FakeIP, 192.168.18.x]
    
D --&gt; F[FakeIP]

C --&gt; G{A根据ip网段进行路由判断}
F --&gt; G
    
G -- 目标IP为普通地址 --&gt; H[通过A WAN口请求]
G -- 目标IP为FakeIP网段 --&gt; I[路由至B， 请求至OpenClash]

I --&gt; J[截获FakeIP数据包&lt;br&gt;还原为真实目标域名]
J --&gt; K[请求被指向目标代理服务器]

K --&gt; L[请求返回A]
L --&gt; H
</pre><p>如图所示，在这种网络链路下，国内请求不会经过OpenClash，同时为了控制OpenClash影响的CPU和内存范围，我选择在ESXi内单独起了一个虚拟机，用ESXi进行最大CPU和内存的限制，尽可能做到在OpenClash异常时不会耗尽整个路由器资源。至于为什么要再套一层OpenWrt而不是直接部署OpenClash，那是为了后续有其他插件需要安装时也可以从主链路中剥离开。</p><p>而在2024年，为什么我还将HomeAssistant部署在软路由内，原因是当时高估了软路由的性能，并且因为担心服务器挂了可能会影响智能家居设备=.=</p><h2 id=服务器的调整>服务器的调整<a hidden class=anchor aria-hidden=true href=#服务器的调整>#</a></h2><p>首先提一下硬件上的调整(上图中没展示出来)，由于需要按资料重要性进行资源隔离，我新增了2块二手12T的氦气盘组了RAID 1阵列，高频读写的PT、影音等数据存在这个阵列内，原先的阵列用来存放家庭照片、数据备份、文档备份等。</p><p>然后是服务器内部署的一些应用进行了调整:</p><ul><li>移除Jellyfin：由于我没有在外看视频的需求，在家的话不需要在服务器上进行解码，直接传流手机解码即可，最终方案是在手机和电视上安装了infuse作为媒体观看软件。</li><li>PhotoPrism替换为MTPhotos: PhotoPrism属实难用。</li><li>新增 Alist（网盘管理）、Calibre（电子书管理）。</li><li>部署Ubuntu虚拟机: 用来部署相关的监控脚本。</li><li>计划上会添加上prometheus+grafana作为监控套件，但实际2024年并未添加</li></ul><p>在增强稳定性方面，服务器上的脚本担任了绝大多数的任务需求，整个监控体系如下图所示:
<img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/2024-%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F.png></p><p>其中的脚本都是非常简单的shell脚本，通过http请求对应服务的管理接口，有数据就当有心跳。这里可以看出当时的一个观点：只要不挂都不是大问题（笑）。但这套体系还是有不少的监控盲区和问题，最显而易见的，就是当OpenWrt或者ESXi挂了的时候，push消息根本发不出来（这个问题居然一直到了25年才被反应过来）</p><h1 id=2025年-体系化与稳定性建设>2025年: 体系化与稳定性建设<a hidden class=anchor aria-hidden=true href=#2025年-体系化与稳定性建设>#</a></h1><h2 id=发现问题>发现问题<a hidden class=anchor aria-hidden=true href=#发现问题>#</a></h2><p>上述调整后的架构完美运行了很长时间，期间没有发生任何大问题，偶尔的clash异常也能在重启后恢复。但没出大问题也就意味着上述的降级容灾措施并没有被实际验证过。</p><p>时间来到2025年的夏天，某个周末开始网络会时不时出现卡顿，一开始还以为是PT下载的缘故，由于持续时间不长就没太关注。但慢慢的卡顿频率越来越多，有时候OpenWrt的CPU占用会飙升到100%，排查发现OpenWrt内CPU占用最高的线程是ksoftirqd，ksoftirqd是一个处理软中断的线程，它占CPU高往往是结果而不是原因。深入排查发现在弱电箱内的软路由在正常情况下就烫的厉害，那会不会是因为软路由散热不好导致CPU降频或网卡异常进而触发了软中断爆炸呢，在换了一个更大的散热风扇后，这个情况再没有发生。</p><p>这个事件让我看到了2个问题：</p><ol><li>现有监控无法捕捉瞬时异常，缺乏历史数据追踪。</li><li>软路由的负载过高，需进一步划清设备职责。</li></ol><p>这样下来，2025年的改造目标，重点就是：</p><p><strong>建设体系化监控+设备能力单一化</strong></p><h2 id=监控体系升级>监控体系升级<a hidden class=anchor aria-hidden=true href=#监控体系升级>#</a></h2><p>其实在2024年的规划中，就已经画出了grafana+prometheus的套件组合，但由于prometheus过于原始的配置方式，加上当时认为脚本探活就可以完成家庭网络的监控工作，这2者并没有被使用起来。</p><p>回到现在，监控体系还是选择使用grafana+prometheus的组合，毕竟开源解决方案很多。安装后的效果如下。</p><p><img loading=lazy src=/img/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C/2025-grafana.png></p><p>关于prometheus exporter的选择，目前是这样的:</p><table><thead><tr><th>监控节点</th><th>拉取速度</th><th>核心关注指标</th><th>exporter来源</th></tr></thead><tbody><tr><td>OpenWrt</td><td>5s</td><td>CPU使用率、内存使用率、load、网络io、活跃连接数</td><td>OpenWrt软件包内自带</td></tr><tr><td>HomeAssistant</td><td>30s</td><td>设备电池电量、空调使用时间</td><td>HA插件</td></tr><tr><td>TrueNAS</td><td>5s</td><td>CPU使用率、内存使用率、load、磁盘io、网络io</td><td><a href=https://github.com/Supporterino/TrueNAS-graphite-to-prometheus target=_blank rel=noopener>https://github.com/Supporterino/TrueNAS-graphite-to-prometheus</a></td></tr><tr><td>qBittorrent</td><td>60s</td><td>下载/上传速度、做种数</td><td>自建</td></tr><tr><td>OpenClash</td><td>20s</td><td>下载/上传速度、流量使用量、活跃连接数、国内/国际ping延时</td><td>自建</td></tr></tbody></table><p>需要提的是为什么没有ESXi的exporter，原因是不想为了监控再装一个vCenter了=。=</p><h2 id=日志>日志<a hidden class=anchor aria-hidden=true href=#日志>#</a></h2><blockquote><p>日志及下述单一化的部分在这篇文章写作之时并没有完全调整完成，这里主要说一下我的方案。</p></blockquote><p>既然监控使用了grafana，日志当然使用promtail+loki的配套搭配，但看了文档发现promtail目前已经被弃用了，替代者是alloy，所以整个的日志方案就变成了alloy(日志采集)+loki(日志存储)+grafana(日志看板)的组合拳。</p><p>TrueNAS内的日志采集直接部署alloy应用即可，日志基本集中在/var/log目录下，我目前是采集了/var/log/containers/*和/var/log/syslog.log用以监控应用和系统的关键日志。</p><p>OpenWrt的日志采集，我决定参考 <a href="https://github.com/defanator/openwrt-loki-exporter?tab=readme-ov-file" target=_blank rel=noopener>github</a> 的方案在OpenWrt内直接部署日志上报的功能。</p><p>ESXi和HomeAssistant暂不接入。</p><h2 id=设备职责单一化>设备职责单一化<a hidden class=anchor aria-hidden=true href=#设备职责单一化>#</a></h2><p>在软件工程里，KISS原则是一个非常重要的工程实践方法。回看前两年迭代的结构演进，有哪些地方违法了KISS原则呢？</p><ol><li>为了减少OpenClash对系统的影响，引入了mosdns进入主链路。</li><li>软路由内部署了HomeAssistant。</li><li>存储服务器承担了越来越多的计算工作。</li></ol><p>要如何解决这3个问题呢，我目前的方案如下：</p><p>关于问题1, 当我在2025年再次审视clash的配置时，发现其实clash本身就支持dns分流及按配置绕过内核，引入mosdns似乎并不需要，于是我将2个OpenWrt再次删减为一个，仅使用OpenClash的规则配置进行流量分流，这个方案带来的唯一问题可能CPU会被clash吃满，但这通过监控也可以完成clash自动启停。关于clash的配置，github上的<a href=https://github.com/Aethersailor/Custom_OpenClash_Rules target=_blank rel=noopener>这个仓库</a>有非常详尽的教学，可以参考。</p><p>关于问题2, 很好解决，我将HomeAssistant从软路由迁移至服务器。</p><p>关于问题3，这实际是个成本问题（哈哈）。随着监控和日志系统的完善，我计划观察一段时间服务器使用，如果确实日常计算量很高，可能会考虑增加一台专用计算的设备保障存储设备的稳定性。（比如mac mini）</p><h1 id=最后>最后<a hidden class=anchor aria-hidden=true href=#最后>#</a></h1><p>家庭网络的建设是一个持续迭代的过程，从最初的“能用到”到“稳定用”，再到“高效与可观测”，每一个阶段都伴随着新的挑战与解决方案。本文重点分享了设计思路与架构演进，具体技术细节将在后续文章展开。如果你也正在构建家庭网络，希望本文能为你提供一些参考。</p></div><script src=https://cdn.bootcdn.net/ajax/libs/mermaid/11.9.0/mermaid.min.js></script><script>const elementCode=".mermaid",loadMermaid=function(e){mermaid.initialize({theme:e}),mermaid.init({theme:e,themeVariables:{fontFamily:["SFProText-Regular","LXGWWenKaiScreenR"]}},document.querySelectorAll(elementCode))},saveOriginalData=function(){return new Promise((e,t)=>{try{var n=document.querySelectorAll(elementCode),s=n.length;n.forEach(t=>{t.setAttribute("data-original-code",t.innerHTML),s--,s==0&&e()})}catch(e){t(e)}})},resetProcessed=function(){return new Promise((e,t)=>{try{var n=document.querySelectorAll(elementCode),s=n.length;n.forEach(t=>{t.getAttribute("data-original-code")!=null&&(t.removeAttribute("data-processed"),t.innerHTML=t.getAttribute("data-original-code")),s--,s==0&&e()})}catch(e){t(e)}})};saveOriginalData().catch(console.error);let isdark=document.body.className.includes("dark");isdark?resetProcessed().then(loadMermaid("dark")).catch(console.error):resetProcessed().then(loadMermaid("neutral")).catch(console.error),document.getElementById("theme-toggle").addEventListener("click",()=>{resetProcessed(),document.body.className.includes("dark")?loadMermaid("neutral"):loadMermaid("dark").catch(console.error)})</script><footer class=post-footer><ul class=post-tags><li><a href=https://asukaonly.github.io/tags/home/>Home</a></li></ul><nav class=paginav><a class=next href=https://asukaonly.github.io/posts/play-framework/part3play%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E5%90%AF%E5%8A%A8/><span class=title>Next »</span><br><span>Play framework源码解析 Part3:Play的初始化与启动</span></a></nav></footer><script src=https://utteranc.es/client.js repo=asukaonly/asukaonly.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://asukaonly.github.io/>404 NOT FOUND</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>