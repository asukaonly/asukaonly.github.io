+++
title = '家庭网络设计方案'
date = 2025-02-09 20:09:05
tags = ["home"]
categories = ["home"]
+++

# 写在最前
早在毕业后的租房时期，就时常期待有了自己的家后要进行怎么样的网络改造，每次看网上博主各种内网万兆传输、服务器机柜、nas整列等等都心生羡慕，在2023年新家入住后的2年内，针对家庭网络的改造一直断断续续的持续进行中，在2年后的2025年，感觉也算完成了当前阶段的一个目标了，是时候写一点东西总结一下相关的内容了。决定按以下内容分别理一下我组建家庭网络的心得。

1. 家庭网络设计方案
2. 软路由方案
3. 家庭服务器方案
4. 智能家居方案

这篇我着重聊一下这2年家庭网络结构的发展过程及心路历程。

# 房屋结构和网络需求
由于房屋是精装交付，成本考虑在入住装修时没有进行大幅结构改造（这也给后续改造带来了种种问题😭），简略结构图如下：

![](/img/家庭网络/房屋结构.png)

入住前暴露的主要问题有以下几点：

1. 弱电箱嵌入在进门鞋柜内，内部空间非常有限，没法塞入很多网络设备，且散热不好。
2. 网口较少，无线AP只能放置在客厅的位置，书房会存在一定的wifi死角。
3. 装修内置的是超5类网线，虽短距能上万兆，但稳定性受影响。

而我对家庭网络能力的主要需求如下：
| 需求              | 必要性 | 备注 |
| ---------        | ----------- | ----------- |
| 全屋透明代理       | ⭐⭐⭐⭐⭐       | 满足全屋代理的同时，需要过滤pt流量/大陆域名请求等
| 内网2.5G速率      | ⭐⭐⭐⭐⭐        | 综合考虑，部署万兆的成本过高，日常使用2.5G已够使用
| 内网穿透          | ⭐⭐⭐⭐          | 游戏联机/家庭相册共享需要
| 支持内网私有域名    | ⭐⭐⭐⭐         | 简化日常内网部署应用的使用
| 网络监控/恢复能力   | ⭐⭐⭐          | 提升故障问题发现率
| 智能家居内网部署  | ⭐⭐              | 智能家居设备使用走内网提升速率并支持离线使用
| 隐私设备子网隔离 | ⭐⭐            | 摄像头、传感器类iot设备屏蔽公网
| 容灾能力          | ⭐             | 减少故障发生后的恢复时间

基于以上的需求，可以得到以下的初步结论
1. 由于需要全屋透明代理，故需要使用软路由做主路由的方案，这里我选用OpenWrt作为我的软路由系统。（个人不喜欢旁路由模式，不够透明也不够旁🐶）
2. 由于需要全屋2.5G速率，硬件上交换机/AP/设备网口均需要支持2.5G协商速率。（被只支持1G和10G的万兆卡坑过）
3. 由于需要内网穿透+私有域名等需求，需要软路由系统有相关的功能支持.(关注版本功能)
4. 由于需要智能家居内网部署，购买设备时需要关注是否支持zigbee/matter等协议。

# 2023年：先跑起来

## 物理设备
2023年的主题是建设，在入住后不久，我就对期望的网络规划进行了一定的设计，设备间的拓扑图如下：
![](/img/家庭网络/2023-网络拓扑.png)

可以看到这里用了不太常见的单臂路由作为主路由连接方案，并不是因为软路由只有一个网口，纯粹是当时考虑如果软路由放在弱电箱内散热不太好。

我的主要网络设备如下：
* 软路由：零刻eq12(n100/16G)
* 交换机：TP-LINK网管交换机+水星非网管交换机
* 无线ap：小米ax7000
* 服务器：X11SCA-F+E2144+64G

硬件配置上普普通通，甚至有些富裕。当然，在闲鱼淘的交换机还是带起了后续的一些变化（笑

## 系统建设

系统拓扑如下图所示
![](/img/家庭网络/2023-系统拓扑.jpg)

### 软路由

软路由中，我没有直接安装OpenWrt固件，而是套了一层esxi，当时主要有以下几个考虑：
1. 部署便利：套一层虚拟机便于在更改网络配置时不需要进行物理空间内的布线调整。
2. 容灾能力：esxi有完善的备份还原机制，我可以通过备份快速恢复网络配置。
3. 性能考虑：觉得软路由性能过剩，除了OpenWrt还可以安装其他的系统（这点后来证明并不正确）。
4. 上手程度：为什么不选用pve是因为相对来说对esxi更熟悉一些/

在esxi内，Openwrt用的是恩山上找的一个高大全版本，后来证明里面的软件绝大多数都没有用，还时常卡死。

HomeAssistant在2023年被安装在软路由内，一是因为软路由设备先于服务器购买，出于调教智能家居设备的原因先安装在软路由内，二是HA需要安装HAOS才能安装插件（即必须是虚拟机版本，不能部署在容器内），当时认为truenas的虚拟机能力并没有esxi好，所以服务器买来后也没有进行迁移（当时忽视了了硬件能力，n100怎么敢和e2144比性能😅）

### 服务器

2023年618，我筹备组建第一台服务器，当时我对服务器的主要诉求是以下几点：
1. 是一台偏存储的服务器，需要能装插入多块硬盘。
2. 需要支持ecc内存。
3. 需要带核显，支持视频硬解。
4. 需要组RAID，需要支持sas硬盘。
5. 需要能装虚拟机/容器。

在淘了比较久的垃圾后，最终选用的配置如下：
* 主板: 超微X11SCA-F
* CPU: intel E-2144G
* 内存: 三星DDR4 2666 32G ECC *2 
* 硬盘: 希捷酷鹰4T*4
* 网卡: 迈络思MCX311A
* 机箱: 半人马座
* 电源: 海韵SGX500

![](/img/家庭网络/半人马.jpeg)

这套配置里，最先选择的是机箱，因为家里没有位置放置机柜，想要多盘位又不想装较大的塔式机箱，最终入了半人马的机箱，颜值和扩展相对不错。

cpu上，2144g的性能和能耗较为平衡，且核显有QSV能力，能加速视频编解码，主频3.6睿频4.5也能较好的应付日常的计算工作。
![](/img/家庭网络/E2144g.png)

内存上由于心心念念一直想要搞一套ecc内存，这次选用了三星的ddr4 2666的纯ecc内存条(24年还坏了一根😭)，计划是先装64g的跑跑，后期会加到128g。

这套配置有几个小插曲，一是网卡一开始买的浪潮电口X540, 没想到居然不支持2.5G协商速率，害的我又重新买了一块。二是由于机箱比较小，虽然能装atx板，但硬盘接口的位置都被挡住了，没办法后续加装了一块SAS直通卡解决。

在系统上，由于是偏存储的服务器，系统更偏向选择一些具备nas功能的系统，在Unraid/TrueNAS等一众nas系统及linux原生/虚拟机系统的抉择下，我最终选择了以truenas作为我的服务器系统，理由主要是以下几点:
1. 相比Unraid等nas系统，TrueNAS使用ZFS文件系统，有完善的数据验证、快照、恢复等机制。
2. 相比直接部署linux系统, TrueNAS上有更易上手的RAID管理/监控等能力。
3. 相比部署虚拟机系统，如esxi或proxmox，由于TrueNAS scale已经支持了虚拟机和容器，我不需要再加一层套娃。

RAID方面，我的4块4T酷鹰组了RAIDZ1(RAID5)，实际容量在10T左右，确保在一块坏了的时候能够不丢失数据恢复。

软件层面，为了使用更多已经封装好的应用，我安装了不少truecharts社区的应用，像tinymediamanager/photoprism等，这也为后续发送的事埋下了一个大坑。2023年主要安装的是以下一些应用：
* qBittorrent: 挂pt及资源下载用的
* homepage: 家用控制台，能比较方便的基础各种数据。
* icloudpd: 同步iCloud照片至服务器
* jellyfin: 媒体服务器
* tinymediamanager: 视频刮削，jellyfin的刮削能力比较一般，tinymediamanager的能力更强一些
* photoprism: 照片管理

在2023年，整体的家庭网络设计就如上述展示的，没有太多出挑和个性化的内容，更多的是在进行初步的建设，这其中科学上网/HA智能家居的配置细节放到后续的文章内阐述。

# 2024年: 墨菲定律

## 遇到了什么问题
上述的拓扑支撑了2023下半年至2024年上半年结束，整体还算稳定，但也有许多小问题，比如pt流量过了代理把我的流量全耗干、OpenClash抽风导致网络卡死等，算是在我能接收的范畴内。然而以上的拓扑存在一个致命的问题，如果弱电箱里那台网管交换机挂了，怎么办？

在一般网络拓扑情况下，某项设备，只需拿库存的替换一下，在新设备到来前最多有些性能损失，网络还是可用的，替换算上安装、配置的时间最多也就是半个小时的事。但目前拓扑下，网管交换机坏了，首先是我没有库存的网管交换机设备，二来由于要去配置vlan，我需要先将设备连接到pc上，更改完vlan设置和静态地址后，再插回弱电箱。由于vlan是和端口相关的，端口的连接顺序还必须和之前的保持一致，不然esxi内的配置就会异常，如果凑巧忘记了原先的设置，那么要么从头再来一遍要么一遍遍插拔试错。

而就在2024年的5月某天，那台网管交换机突然宕机了，我在重新下单等了2天收到货后开始配置，才发现完全不记得之前的vlan设置了，当时正值618之际，在每天晚上下班仅有的2个小时内，我花了2天才将家庭网络恢复如初。只后，我决定对现有的网络进行改造，这次改造的重点是:

**增强稳定性+建设容灾恢复能力**

## 核心链路

既然要增强系统稳定性及容灾能力，首要的就是需要梳理一下目前的网络元素以及相关的可用性需求。

| 链路               | 可用性需求  | 达到可用时的最少设备 | 达到可用时的最少系统组件 |
| -----------------  | --------  | -------- |  -------- |
|   全屋正常访问国内网络 | 必须高可用   | 路由器  | 无
| 正常访问国际网络      |   | 路由器 | OpenClash
| 内网穿透          | ⭐⭐⭐⭐   | 游戏联机/家庭相册共享需要                          |
| 支持内网私有域名  | ⭐⭐⭐⭐   | 简化日常内网部署应用的使用                         |
| 网络监控/恢复能力 | ⭐⭐⭐    | 提升故障问题发现率                                 |
| 智能家居内网部署  | ⭐⭐     | 智能家居设备使用走内网提升速率并支持离线使用       |
| 隐私设备子网隔离  | ⭐⭐     | 摄像头、传感器类iot设备屏蔽公网                    |
| 容灾能力          | ⭐      | 减少故障发生后的恢复时间                           |

## 物理拓扑的调整
在一通调整后，我的物理拓扑图变成了这样:

![2024-网络拓扑](/img/家庭网络/2024-网络拓扑.png)

从物理拓扑上来看，改变不算特别大，仅是将路由器从书房移回了弱电箱，但从稳定性的角度考虑，这一项调整让家庭减少了2个强依赖项，一个就是上面说的网管交换机，就算挂了我也可以替换为普通交换机，甚至不用交换机直连客厅的无线ap。另一个就是去除了弱电箱到书房的网线这个强依赖，一旦网线出问题，仅需降级书房的有线网络即可保障家庭网络的稳定性。

至于软路由的散热问题，一来在这一年的使用过程中，温度还算可控。二来我买了一个usb温控风扇贴着吹进行散热，整体评估放在弱电箱内问题不大。（是吗=。=）

## 系统拓扑的调整
在系统拓扑方面，改造的东西就相对较多一些了，在聊改造细节之前，我们还是先来看看当下遇到的问题有哪些：

1. 由于OpenClash的性能问题，导致间歇性的断网。
2. 当OpenClash的目标节点异常时没有主动感知，在连不上外网或者速度很慢时才能发现进行切换。
3. PT流量会经过代理服务器导致流量耗尽。
4. 所有数据共用一个磁盘组，pt和重要数据的区分不够，有数据丢失风险，重要数据没有备份机制。
5. 网络的整体监控能力较弱，出现问题无法溯源。
6. 缺少各关键节点的容灾能力。

为了解决以上的问题，系统的拓扑变成了这样：

![2024-网络拓扑](/img/家庭网络/2024-系统拓扑.jpg)

## 软路由内的调整

由上图所示，软路由内最大的一个改变，就是将OpenClash从拨号的OpenWrt内剥离了出去，并将拨号用的OpenWrt更改为了自编译的精简版本，插件只包含了阿里ddns和mosdns，其中阿里ddns用于内网穿透，而mosdns用做代理分流使用。

首先来说明一下这样调整后的网络请求顺序，为方便说明，拨号用的OpenWrt简称为A， OpenClash所在的OpenWrt简称B：

```mermai
flowchart TD
A[客户端访问域名<br>默认网关为A] --> B[A中的DNS服务由mosdns劫持，判断是否为国内域名]
B -- 国内域名 --> C[真实IP]
B -- 国际域名 --> D[mosdns转发请求至B<br>B中的OpenClash直接返回FakeIP, 192.168.18.x]
    
D --> F[FakeIP]

C --> G{A根据ip网段进行路由判断}
F --> G
    
G -- 目标IP为普通地址 --> H[通过A WAN口请求]
G -- 目标IP为FakeIP网段 --> I[路由至B， 请求至OpenClash]

I --> J[截获FakeIP数据包<br>还原为真实目标域名]
J --> K[请求被指向目标代理服务器]

K --> L[请求返回A]
L --> H

```

如图所示，在这种网络链路下，国内请求不会受到OpenClash的影响，同时为了控制OpenClash影响的CPU和内存范围，我选择在esxi内单独起了一个虚拟机，用esxi进行最大cpu和内存的限制，尽可能做到在OpenClash异常时不会耗尽整个网络资源。至于为什么要再套一层OpenWrt而不是直接部署OpenClash，那是为了后续有其他插件需要安装时也可以从主链路中剥离开。

# 2025年: 奥卡姆剃刀

